# Summary

Implementing a Spinnaker pipeline resource.  

## Features :
   - Trigger a Spinnaker pipeline with optional artifacts from Concourse.
   - Trigger a Concourse job based on the status of a Spinnaker pipeline.

The idea is build on an already existing [resource](https://github.com/burdzwastaken/concourse-spinnaker-resource).

## Source Configuration

- `spinnaker_api`: the url of the Spinnaker api microservice. 
- `spinnaker_application`: The Spinnaker application you would like to trigger.
- `spinnaker_pipeline`: The Spinnaker pipeline you would like to trigger.
- `skip_ssl_verification`: **TODO** make sure it is possible.
- `client_x509_cert`: Client [certificate](https://www.spinnaker.io/setup/security/authentication/x509/) to authenticate with Spinnaker.
- `client_x509_key`: Client [key](https://www.spinnaker.io/setup/security/authentication/x509/) to authenticate with Spinnaker.
 `check_statuses`: *Optional* Array of Spinnaker pipeline execution statuses used to filter new versions during `check` stage. Currently supported statuses by Spinnaker: [NOT_STARTED, RUNNING, PAUSED, SUSPENDED, SUCCEEDED, FAILED_CONTINUE, TERMINAL, CANCELED, REDIRECT, STOPPED, SKIPPED, BUFFERED] - [Reference](https://github.com/spinnaker/gate/blob/1cb00104f925e484d7a7a333bf07bd149adb0464/gate-web/src/main/groovy/com/netflix/spinnaker/gate/controllers/ExecutionsController.java#L82). If not specified, each pipeline execution will yield a new version regardless.

## Behaviour

### `check`

Pipeline executions will be found by fetching pipeline executions for the configured application, filtered by the pipeline name. If `statuses` is configured, the list will be filtered by statuses.

The pipeline execution `id` will be used as the version of the resource.

### `in`

Places the following files in the destination:

 - `metadata.json`: Contains the pipeline execution metadata returned from the Spinnaker [api](https://www.spinnaker.io/reference/api/docs.html#api-Pipelinecontroller-getPipelineUsingGET).

 - `version`: A file containing the pipeline execution id.

### `out`: Triggers a pipeline

Triggers a Spinnaker pipeline.

#### Parameters
- `required_status`: *Optional* A status that is required for the put step to succeed.
- `required_status_timeout`: *Optional* The amount of time after which the put step will timeout waiting for the `required_status`. Default value will be `30m`.

**NOTE:** Any [metadata](http://concourse.ci/implementing-resources.html#resource-metadata) in the parameters will be evaluated prior to triggering the pipeline. 

##### Artifacts
###### Option 1
  - `artifacts_json_file`: *Optional* path to a file containing the artifacts to trigger the spinnaker pipeline with. File should be a json, and contains an array of artifacts to trigger along with the pipeline in the [spinnaker artifact format](https://www.spinnaker.io/reference/artifacts/#format). 

###### Option 2
  - `artifacts`: *Optional* Array of file paths, each of which corresponds to a single Spinnaker artifact. File should conform [spinnaker artifact format](https://www.spinnaker.io/reference/artifacts/#format). 

##### Trigger Params
###### Option 1
- `trigger_params`:
    - `static_params`: Static key value params (can be any key/value pair), also concourse metadata can be used.
    - `json_file`: Path to JSON file, where contents will be used as the root of trigger params. If duplicate keys exist, the contents will override keys in `static_params`
    - `file_params`: Map<KEY_NAME><PATH_TO_FILE>, where contents of the file will be used as values.

    Example
```yml
    trigger_params: 
        static_params: 
            some_key: some_value
            some_other_key: some_other_value 
        json_file: PATH_TO_JSON_FILE
        file_params:
            first_key: PATH_TO_FILE_1
            second_key: PATH_TO_FILE_2
```

###### Option 2
- `trigger_params`: *Optional* build information to send to Spinnaker pipeline execution which can be consumed by the [pipeline expressions](https://www.spinnaker.io/guides/user/pipeline-expressions/). Can be any key/value pair.
- `trigger_params_json_file`: *Optional* Path to a file that contains parameters to push to the Spinnaker pipeline. This allows the file to be generated by a previous task step. Contents of this file will be merged with `trigger_params`. Duplicate keys will be overwritten with the contents in the file. 
- `resource_path` : *Optional* Path to a resource directory. This will post params of the following format to Spinnaker;
    ```json
    "parameters" : {
        "name": VALUE_OF_RESOURCE_PATH,
        "version": CONTENTS_OF_RESOURCE_VERSION_FILE
    }
    ```

## Example Pipelines

### Put
```yml
---
resource_types:
- name: spinnaker
  type: docker-image
  source:
    repository: concourse/concourse-spinnaker-resource

resources:
  - name: spinnaker
    type: spinnaker
    source:
      spinnaker_api: ((spinnaker-api))
      client_x509_cert: ((client-x509-cert))
      client_x509_key: ((client-x509-key))
      spinnaker_application: samplespinnakerapp
      spinnaker_pipeline: samplespinnakerpipeline

jobs:
- name: trigger-pipeline
  plan:
  - put: spinnaker
    params:
      trigger_params:
        build_id: (build ${BUILD_ID})
```

### Get
```yml
---
resource_types:
- name: spinnaker
  type: docker-image
  source:
    repository: concourse/concourse-spinnaker-resource

resources:
  - name: spinnaker
    type: spinnaker
    source:
      spinnaker_api: ((spinnaker-api))
      client_x509_cert: ((client-x509-cert))
      client_x509_key: ((client-x509-key))
      spinnaker_application: samplespinnakerapp
      spinnaker_pipeline: samplespinnakerpipeline
      statuses:
        - SUCCEEDED
        - TERMINAL

jobs:
- name: trigger-pipeline
  plan:
  - get: spinnaker
    trigger: true
```
